var PollsFactory = {colors: null};
var form_submitted = false;
(function($){
	PollsFactory.init_common = function(){
		$('body').on('mouseover', '.tooltip-hover', function(){$(this).tooltip('show');});
		$(document.body).append($('<div>', {'id': 'cj-wrapper'}).append($('#cj-wrapper').find('div.modal')));
		$('#cj-wrapper').find('[data-relocate]').each(function(){
			var ele = $(this);
			$(ele.attr('data-relocate')).append(ele);
		});
		
		$('.accordion-toggle').click(function(e){
			var mybody = $(this).attr('href');
			e.preventDefault();
			if($(mybody).is(':hidden')){
				$(mybody).closest('.accordion').find('.accordion-body').not(mybody).slideUp();
				$(mybody).slideDown();
			} else {
				$(mybody).slideUp();
			}
		});
		
		$('#cj-wrapper').find('#btn_search').click(function(){
			document.toolbarFilterForm.list_filter.value = $('#cj-wrapper').find('#filter_search').val();
			document.toolbarFilterForm.submit();
		});
		
		$('#cj-wrapper').find('#filter_search').keypress(function(e){
			if ( e.which == 13){
				$('#cj-wrapper').find('#btn_search').click();
			}
		});
	};

	PollsFactory.init_poll_form = function(){
		$('#myTabTabs').find('a[href="#editorFields"]').on('shown', function (e) {
			if($('#editorFieldsWrapper').find('#editorFields').length == 0){
				$('#jform_description').sceditor('instance').height(200).width('98%');
				$('#jform_end_message').sceditor('instance').height(200).width('98%');
			}
		});
		if($('#poll-options').find('.poll-option').length == $('#poll-options').find('.hide').length){
			$('#poll-options').hide();
		}
		
		/********* Start validation messages **********/
		if($().validate)
		{
			var msg_required = $('#msg_field_required').text();
			var messages = new Object();
			$('#cj-wrapper').find('.required').each(function(){
				messages[this.name] = { required: msg_required };
			});
			
			$('#cj-wrapper').validate({messages: messages});
			$('#submit-url-form').validate();
		}
		/********* End validation messages ***********/

		$('select[name="jform[type]"]').chosen().change(function(){
			if($(this).val() == 'grid'){
				$('.poll-columns-wrapper').show();
			}else{
				$('.poll-columns-wrapper').hide();
        	}
        });

		$pallete_colors = $.parseJSON($('.pallete-'+$('#cj-wrapper').find('.pallete').val()).html());
		$.each($pallete_colors, function(index, val){
			$('.selected-pallete').append($('<span>').css('background-color', val).html('&nbsp;'));
    	});
		
		$('#cj-wrapper').find('.pallete').change(function(){
			var pallete = $(this).val();
			$pallete_colors = $.parseJSON($('.pallete-'+pallete).html());
			$('.selected-pallete').empty();

			$.each($pallete_colors, function(index, val){
				$('.selected-pallete').append($('<span>').css('background-color', val).html('&nbsp;'));
			});
        });

        // add new answer and new grid column button functions.
		$('.btn-add-answer').click(function(){
			$('.poll-answers').find('.panel-body').append($('.poll-answer-template').html());
			$('.poll-answers').find('.poll-answer:last').find('.input-order').val( $('.poll-answers').find('.poll-answer').length );
        });
		
		$('.btn-add-column').click(function(){
			$('.grid-columns').find('.panel-body').append($('.poll-column-template').html());
			$('.grid-columns').find('.poll-answer:last').find('.input-order').val( $('.grid-columns').find('.poll-answer').length );
        });
		
		// file upload button function
		var upload_button = null;
		$('.poll-answers').on('click', '.btn-add-media', function(){
			upload_button = $(this);
			$('.input-file-upload').click();
        });
		
		$('.input-file-upload').change(function(){
			button = upload_button;
			button.find('i').addClass('btn-progress').removeClass('icon-picture');
			$('.file-upload-error').hide().find('.error-msg').html('');
			
			$('#file-upload-form').ajaxSubmit({
				dataType : 'json',
				success: function(data, status, xhr, $form) {
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('.file-upload-error').show().find('.error-msg').html(data.error);
					}else{
						var template = $('.poll-resource-template');
						template.find('.resource-value').html(data.file_name);
						template.find('input[name="resource-image"]').val(data.file_name);

						button.closest('.poll-answer').find('.poll-answer-resources').append(template.html());
					}
					button.find('i:first').addClass('icon-picture').removeClass('btn-progress');
				}
			});
		});

		$('#cj-wrapper').on('click', '.btn-delete-attachment', function(){
			$(this).closest('.poll-resource').remove();
		});

		$('#cj-wrapper').on('click', '.btn-delete-answer', function(){
			$(this).closest('.poll-answer').remove();
		});

		// add url button function of add media block
		$('#cj-wrapper').on('click', '.btn-add-url', function(){
			var button = $(this);
			$('#add-url-modal').modal('show');

			$('#add-url-modal').find('.btn-submit').off().click(function(){
				if(!$().validate || $('#add-url-modal').find('input[type="text"]').valid()){
					if(button.closest('.poll-answer').find('.poll-answer-resources').find('input[name="resource-url"]').length > 0){
						button.closest('.poll-answer').find('.poll-answer-resources').find('input[name="resource-url"]').closest('.poll-resource').remove();
					}
            		
					var template = $('.poll-resource-url-template');
					var url = $('#add-url-modal').find('input[type="text"]').val();
					template.find('.resource-value').html(url);
					template.find('input[name="resource-url"]').val(url);
					template.find('i:first').attr('class', 'icon-globe');
					button.closest('.poll-answer').find('.poll-answer-resources').append(template.html());
					$('#add-url-modal').modal('hide');
					$('#add-url-modal').find('input[type="text"]').val('');
				}
			});
		});
	};
	
	PollsFactory.load_form_data = function(){
		var poll_answers = Array();
		var grid_columns = Array();
		var answer = null;
		var order = null;

		$('.poll-answers').find('.poll-answer').each(function(){
			answer = $(this).find('.input-answer').val();
			try{order = parseInt($(this).find('.input-order').val());}catch(e){order = 0;}

			if(answer != null && answer.length > 0){
				var poll_answer = new Object();
				if($(this).find('input[name="answer-id"]').length > 0){
					poll_answer.id = $(this).find('input[name="answer-id"]').val();
				}else{
					poll_answer.id = 0;
				}
        		
				poll_answer.title = answer;
				poll_answer.order = order;
				poll_answer.type = 'x';
				
				poll_answer.resources = Array();
				var url = $(this).find('input[name="resource-url"]').val();
				
				if(url != null && url != ''){
					var objUrl = new Object();
					objUrl.type = 'url';
					objUrl.value = url;
					
					poll_answer.resources.push(objUrl);
				}

				$(this).find('input[name="resource-image"]').each(function(){
					var objImg = new Object();
					objImg.type = 'image';
					objImg.value = $(this).val();
					
					poll_answer.resources.push(objImg);
				});

				poll_answers.push(poll_answer);
			}
		});

		$('.grid-columns').find('.poll-answer').each(function(){
			answer = $(this).find('.input-answer').val();
			try{order = parseInt($(this).find('.input-order').val());}catch(e){order = 0;}

			if(answer != null && answer.length > 0){
				var poll_answer = new Object();
        		if($(this).find('input[name="poll-id"]').length > 0){
        			poll_answer.id = $(this).find('input[name="poll-id"]').val();
        		}else{
        			poll_answer.id = 0;
        		}
        		
        		poll_answer.title = answer;
        		poll_answer.order = order;
        		poll_answer.type = 'y';

				poll_answer.resources = Array();
				var url = $(this).find('input[name="resource-url"]').val();
				
				if(url != null && url != ''){
					var objUrl = new Object();
					objUrl.type = 'url';
					objUrl.value = url;
					
					poll_answer.resources.push(objUrl);
				}
        		
        		grid_columns.push(poll_answer);
    		}
    	});
    	
    	$('input[name="jform[poll-final-answers]"]').val(JSON.stringify(poll_answers));
    	$('input[name="jform[poll-final-columns]"]').val(JSON.stringify(grid_columns));
    	
    	return true;
	};
	
	PollsFactory.load_gpie_chart = function(params){
		var container = params.container || $('.gpie-chart').get(0);
		var colors = params.colors || $.parseJSON($('#color_pallete').html());
		var answers = params.answers || $.parseJSON($('#poll_answers').html());
		var height = params.height || parseInt($('#chart_height').html());
		var rows = new Array();
		var row = null;

		$.each(answers, function(i, answer){
			row = new Array();
			row.push(answer.title);
			row.push(parseInt(answer.votes));
			rows.push(row);
		});

		var data = new google.visualization.DataTable();
		var chartcolors = new Array();
		data.addColumn('string', $('#lbl_answers').html());
		data.addColumn('number', $('#lbl_votes').html());
		data.addRows(rows);
		
		for(var i=0; i<answers.length; i++){
			chartcolors = chartcolors.concat(colors[i%colors.length]);
		}
		
		var hasClass = $('.poll-results').hasClass('hide');
		if(hasClass) $('.poll-results').removeClass('hide');

		new google.visualization.PieChart(container).draw(data, 
				{'is3D': true, 'legend': 'none', 'width': '100%', 'height': height, 'colors': chartcolors, 'plotAreaFrame.paddingLeft': -1});
		
		if(hasClass) $('.poll-results').addClass('hide');
	},

	PollsFactory.load_charts = function(poll){

       	if(poll.results == true){
    		if(poll.type == 'grid'){
				var grid = $('<table>', {'class': 'table table-hover table-striped table-bordered'});
				var header_row = $('<tr>').append($('<th>', {'class': 'ui-widget-header'}));

				for(var i=0; i<poll.columns.length; i++){
					
					header_row.append($('<th>', {'class': 'ui-widget-header'}).html(poll.columns[i].title));
				}

				grid.append($('<thead>').append(header_row));
				var grid_content = $('<tbody>', {'class': 'poll-content'});
				var content_row = null;

				for(var i=0; i< poll.answers.length; i++){
					content_row = $('<tr>').append($('<th>', {'class': 'ui-widget-header'}).html(poll.answers[i].title));
					for(var j=0; j<poll.columns.length; j++){
						var found = false;
						for(var k=0; k<poll.gridvotes.length; k++){
							if(poll.gridvotes[k].option_id == poll.answers[i].id && poll.gridvotes[k].column_id == poll.columns[j].id){
								found = true;
								content_row.append($('<td>').html(poll.gridvotes[k].votes));
							}
						}
						
						if(!found){
							content_row.append($('<td>').html('0'));
						}
					}
					grid_content.append(content_row);
				}

				grid.append(grid_content);
				$('.poll-results').find('.grid-chart').replaceWith(grid);
    		}else{
        		$.each(poll.answers, function(index, answer){
        			$('.poll-results').find('.answer-'+answer.id).find('.votecount').html(answer.votes);
        			$('.poll-results').find('.answer-'+answer.id).find('.votepct').html(answer.pct+'%');
        			$('.poll-results').find('.answer-'+answer.id).find('.progress-bar:last').css('width', answer.pct+'%');
        		});

        		if(poll.chart_type == 'gpie'){ 
        			// Google pie chart
        			$('.poll-charts-src').empty().append($('<div>', {'class': 'gpie-chart'}));
        			PollsFactory.load_gpie_chart({'answers': poll.answers});
        		}else if(poll.chart_type == 'sbar'){
        			// Simple bar chart
        		}else{
        			// Other image charts
        			d = new Date();
        			$('.poll-charts-src').empty().append($('<img>', {src: poll.src+'?'+d.getTime(), alt: $('#lbl_loading_charts').html()}));
        		}
    		}
    		return true;
    	} else {
			$('#message-modal').find('.modal-body').html($('#lbl_results_hidden').html());
			$('#message-modal').modal('show');
    	}
       	return false;
	},
	
	PollsFactory.init_poll_details = function(){
		var poll_type = $('#poll_type').text();
		
		if($('.gpie-chart').length > 0){
			PollsFactory.load_gpie_chart({});
		}
		$('#timeline').addClass('hide');
		
		if(poll_type == 'radio')
		{
			$('input[name="custom_answer"]').change(function(){
				if($(this).val().length > 0)
				{
					$('input[name="answer"]').prop('checked', false);
				}
			});
			
	//		$('input[name="answer"]').click(function(){
	//			$('input[name="custom_answer"]').val('');
	//		});
		}
		
		$('.suggestions').find('[data-toggle="tab"]').click(function(e) {
		    var loadurl = $(this).attr('href');
		    if(loadurl.substr(0, 1) != '#'){
			    var target = $(this).attr('data-target');
			    $.get(loadurl, function(data) {
			        $(target).html(data);
			    });
		    }
		    $(this).tab('show');
		    $(this).attr('href', $(this).attr('data-target'));
		});
		
		$('.btn-vote').click(function(){
			if(form_submitted) return false;

			if($('.voting-form').find('input:checked').length == 0 && $('.voting-form').find('input[name="custom_answer"]').val() == ''){
				$('#cp-error-message').html($('#error_no_selection').html()).parent().show();
			}else{
				$('#cp-error-message').parent().hide();
				var answers = Array();
				var custom_answer = '';
				var id = $('#poll_id').text();

				$('.voting-form').find('input:checked').each(function(){
					answers.push($(this).val());
				});

				if($('.voting-form').find('input[name="custom_answer"]').length > 0){
					custom_answer = $('.voting-form').find('input[name="custom_answer"]').val();
				}
				
				if(poll_type == 'radio' && answers.length > 0 && $.trim(custom_answer).length > 0)
				{
					$('#cp-error-message').html($('#error_select_one_answer').html()).parent().show();
					return false;
				}
				
				$.ajax({
					url : $('#url_vote').text(),
	                type : 'post',
	                dataType: 'json',
                    data: {
                    	'id': id,
                    	'answers': answers, 
                    	'custom_answer': custom_answer, 
                    	'recaptcha_response_field': $('#recaptcha_response_field').val(), 
                    	'recaptcha_challenge_field': $('#recaptcha_challenge_field').val()
                    },
                    success: function(data) {
                        if(typeof data.error != 'undefined' && data.error.length > 0){
                        	$('.poll-messages').show().find('.poll-end-message').html(data.error);
    						
    						if(typeof Recaptcha != 'undefined'){
    	    					Recaptcha.reload();
    	    				}
                        }else{
                        	PollsFactory.load_charts(data.poll);
                        	$('.poll-messages').show().find('.poll-end-message').html(data.poll.end_message);
                        	$('.btn-view-result').click();
                        	$('.btn-vote').parent().remove();
                        }

                        $('.btn-vote').find('i').attr('class', 'fa fa-hand-o-up');
                        form_submitted = false;
                    },
                    beforeSend: function(){
                    	$('.btn-vote').find('i').attr('class', 'fa fa-spinner fa-spin');
                    	form_submitted = true;
                    }
				});
			}
			
			return false;
		});
		
		$('.btn-view-result, .btn-vote-form').click(function(){
			$('.poll-results').slideToggle('slow');
			$('.voting-form').slideToggle('slow');
			$('.btn-view-result, .btn-vote-form, .btn-vote').toggle();
			return false;
		});
		
		$('.polls-anywhere-code').click(function(){
		    var text = $(this).get(0);

		    if (document.body.createTextRange) { // ms
		        var range = document.body.createTextRange();
		        range.moveToElementText(text);
		        range.select();
		    } else if (window.getSelection) { // moz, opera, webkit
		        var selection = window.getSelection();            
		        var range = document.createRange();
		        range.selectNodeContents(text);
		        selection.removeAllRanges();
		        selection.addRange(range);
		    }
		});

		$('.polls-wrapper').on('click', '.btn-delete-poll, .btn-unpublish-poll', function(){
			var button = $(this);
			$('#confirm-modal').modal('show').find('.btn-confirm').off().click(function(){
				var me = $(this).button('reset');
				me.button('loading');
				$.ajax({
					url: button.attr('href'),
					type: 'post',
					dataType: 'json',
					success: function(data, status, xhr, form){
						if(typeof data.error != 'undefined' && data.error.length > 0){
							$('#message-modal').find('.modal-body').html(data.error);
							$('#message-modal').modal('show');
							me.button('reset');
							$('#confirm-modal').modal('hide');
						}else{
							window.location.replace($('#home_page_url').text());
						}
					}
				});
			});
			return false;
		});
		
		$('#report-item-modal').on('hidden', function () {
			$('#report-item-modal').find('.btn-submit').button('reset');
			$('#report-item-modal').find('.error').html('');
			$('#report-item-modal').find('#inputReason').val('');
			$('#report-item-modal').find('#inputDescription').val('');
		});

		$('#cj-wrapper').on('click', '.btn-report-poll', function(){
			var button = $(this);
			if(!button.hasClass('disabled')){
				$('#report-item-modal').modal('show').find('.btn-submit').off().click(function(){
					$save_btn = $(this);
					$save_btn.button('loading');
					
					$.ajax({
						dataType: 'json',
						url: $('#url-report-poll').text(),
						data: $('.report-form').serialize(),
						success: function(data, statusText, xhr, form){
							$('#report-item-modal').modal('hide');
							button.removeClass('disabled');
							$save_btn.button('reset');
							
							if(typeof data.error != 'undefined' && data.error.length > 0){
								$('#report-item-modal').find('.error').html(data.error);
							}else{
								$('#message-modal').find('.modal-body').html(data.content);
								$('#message-modal').modal('show');
							}
						}
					});
				});
			}
			
			return false;
		});
	};
})(jQuery);

jQuery(document).ready(function($){
	PollsFactory.init_common();
	
	if($("#cjpageid").val() == 'polls'){
		PollsFactory.init_polls_listing();
	}else if($("#cjpageid").val() == 'form'){
		PollsFactory.init_poll_form();
	}else if($("#cjpageid").val() == 'poll'){
		PollsFactory.init_poll_details();
//		PollsFactory.init_addthis_widget();
	}
});